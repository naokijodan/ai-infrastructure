# iOSショートカットでHMAC署名付きWebhookを呼び出す手順

このドキュメントでは、iOSのショートカットアプリを使って、HMAC-SHA256署名付きのWebhookを安全に実行する方法を解説します。

## 1. 前提条件

- Cloudflare Quick Tunnelが起動中であること（`scripts/start-quick-tunnel.sh --daemon`）。
- 現在の公開URL: `https://{tunnel-url}.trycloudflare.com`（`~/ai-scripts/.tunnel-url`で確認）。
- 注意: Quick Tunnelは再起動するとURLが変わるため、再起動後はショートカットのURLも更新が必要。
- HMAC秘密鍵（Webhook検証用シークレット）をiPhoneで安全に参照できること。
  - 例: iCloudキーチェーンの「安全メモ」を利用、またはロック付きメモ・パスワード管理アプリに保存。
  - 秘密鍵は他者と共有しないでください。ショートカット内では「入力を求める」や「変数」に保持し、直接画面に表示しない構成を推奨します。

## 2. ショートカットの作成手順（ステップバイステップ）

以下は最小構成の例です。必要に応じて入力UIやバリデーションを追加してください。

1) 新規ショートカット作成
- ショートカットアプリを開き、「ショートカットを作成」。名前をわかりやすく設定（例: AI Webhook）。

2) テキストアクション: テンプレート名を入力
- アクション「テキスト」を追加。
- 内容にテンプレート名を入力（例: `market-check`）。
- 後続手順ではこのテキストを変数として参照します。

3) テキストアクション: JSONボディを構築
- もう一つ「テキスト」アクションを追加。
- 内容を次の形式にする（引用符・コロン・波括弧を正確に）：

  ```json
  {"template": "(前のテキスト)"}
  ```

- (前のテキスト) の部分は、ショートカットの変数選択から「前のテキスト」アクションの値を挿入してください。

4) スクリプティング > ハッシュ計算: HMAC-SHA256
- アクション「ハッシュを作成」を追加。
- 入力: 直前の「JSONテキスト」アクションの出力。
- ハッシュの種類: SHA-256 を選択。
- 「キー」を有効化して、HMAC用の秘密鍵を入力（または変数で参照）。
  - これにより HMAC-SHA256(JSON本文, 秘密鍵) が生成されます。

5) URLの内容を取得（POST）
- アクション「URLの内容を取得」を追加。
- URL: `https://{tunnel-url}.trycloudflare.com/webhook/Wbc9jJFq15HgqnGa/webhook/claude-exec-secure`
- メソッド: POST
- ヘッダーを2つ追加:
  - `Content-Type: application/json`
  - `X-HMAC-Signature: (前のハッシュ結果)`
- リクエスト本文: 「テキスト」アクションで作成したJSON文字列をそのまま指定。

6) 結果を通知で表示
- アクション「通知を表示」を追加し、「URLの内容を取得」の結果（レスポンス本文）を表示します。

補足:
- テンプレート名を都度入力したい場合は、最初に「入力を要求」アクションを追加し、その入力値をテンプレート変数として利用してください。
- workflow-id を変更したい場合は、URL中の `Wbc9jJFq15HgqnGa` を必要なIDに置き換えてください。

## 3. テンプレート一覧

- market-check
- resale-research
- ai-discussion
- watch-data-add

## 4. トラブルシューティング

- 401/403が返る: 署名不一致の可能性。以下を確認。
  - HMAC秘密鍵が正しいか（サーバ側と一致）。
  - 署名の元データ（JSON本文）がヘッダー送信時の本文と完全一致しているか。
  - `X-HMAC-Signature` ヘッダーが欠落していないか。
- 400やパースエラー: JSONの記法ミス（引用符、カンマ、波括弧の不整合）を見直す。
- タイムアウト/接続失敗: Cloudflare Tunnelの状態や、`ai-infra.{your-domain}` のDNS/Tunnel設定、サーバの稼働状況を確認。
- 500台エラー: サーバ側の処理失敗。サーバログを確認。
- URLミス: workflow-id やパスの綴り、https/ドメインが正しいか確認。
- 文字化け/署名不一致: ショートカットの改行や全角/半角、不要な空白が混入していないか点検。

